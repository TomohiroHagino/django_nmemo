# 画像自動削除機能

## 概要

エディタからコンテンツ内の画像を削除して保存すると、サーバー上の実際の画像ファイルも自動的に削除されるようになりました。

## 実装内容

### 1. 画像削除の仕組み

`PageApplicationService.update_page()`メソッドが以下の処理を実行します：

1. **更新前のコンテンツを保存**
   - 既存のページから現在の画像URLを取得

2. **新しいコンテンツの画像URLを抽出**
   - 更新後のコンテンツから画像URLを取得

3. **削除された画像を特定**
   - 古いコンテンツにあって新しいコンテンツにない画像URLを検出

4. **ファイルシステムから削除**
   - 該当する画像ファイルを物理的に削除

### 2. 主な関数

#### `_delete_removed_images(page_id, old_content, new_content)`
- 古いコンテンツと新しいコンテンツを比較
- 削除された画像ファイルをファイルシステムから削除

#### `_extract_image_urls(content)`
- HTMLコンテンツから`<img>`タグのsrc属性を抽出
- 正規表現を使用: `<img[^>]+src=["']([^"']+)["']`
- すべての画像URLをセットとして返す

### 3. 処理フロー

```
ユーザーがページを更新
    ↓
update_page()が呼ばれる
    ↓
古いコンテンツから画像URLを抽出
    ↓
新しいコンテンツから画像URLを抽出
    ↓
差分を計算（削除された画像を特定）
    ↓
削除された画像をファイルシステムから削除
    ↓
データベースを更新
```

## 使い方

### 通常の使用

1. ページを開く
2. 画像を選択してDeleteキーで削除、または画像を含む部分を削除
3. 「💾 保存」ボタンをクリック
4. → サーバー上の画像ファイルも自動的に削除されます

### 確認方法

削除された画像は、サーバーのコンソールに以下のように出力されます：

```
Deleted removed image: /path/to/media/uploads/page_123/image.jpg
```

エラーが発生した場合は警告メッセージが表示されますが、ページの更新自体は失敗しません：

```
Warning: Failed to delete image /path/to/image.jpg: [エラー詳細]
```

## 技術詳細

### 画像URL抽出の正規表現

```python
pattern = r'<img[^>]+src=["\']([^"\']+)["\']'
```

- `<img[^>]+`: imgタグの開始（閉じ括弧以外の任意の文字）
- `src=["\']`: src属性（ダブルクォートまたはシングルクォート）
- `([^"\']+)`: URL本体（クォート以外の1文字以上）をキャプチャ
- `["\']`: 閉じクォート

### エラーハンドリング

- 画像削除に失敗してもページ更新は継続
- 削除エラーは警告としてログ出力
- ファイルが既に存在しない場合は無視

## 注意事項

1. **複数ページで同じ画像を使用している場合**
   - 現在の実装では、1つのページから削除すると物理ファイルも削除されます
   - 他のページで同じ画像を使用している場合、そちらでも表示されなくなります
   - 将来的には参照カウントの実装を検討

2. **手動でアップロードフォルダを編集しない**
   - `uploads/page_X/`フォルダは自動管理されています
   - 手動で編集すると整合性が取れなくなる可能性があります

3. **バックアップ**
   - 画像削除は即座に実行され、復元できません
   - 重要な画像がある場合は事前にエクスポート機能でバックアップを推奨

## 今後の改善案

- [ ] 画像の参照カウント管理（複数ページでの共有に対応）
- [ ] 削除前の確認ダイアログ（オプション）
- [ ] ゴミ箱機能（一定期間は復元可能）
- [ ] 孤立画像のクリーンアップコマンド


