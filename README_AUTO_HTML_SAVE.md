# 自動HTMLファイル保存機能

## 概要

メモを保存するたびに、そのメモのHTMLファイルが自動的に画像フォルダに保存されるようになりました。

## 機能

### 自動保存

メモを保存（更新）すると、以下の処理が自動的に実行されます：

1. HTMLファイルを生成（画像をBase64で埋め込み）
2. `uploads/page_{id}/` フォルダに保存
3. ファイル名: `{ページタイトル}.html`

### ファイル保存場所

```
Box/000_メインアカ50GB/
└── django_nmemo_data/
    └── media/
        └── uploads/
            └── page_1/
                ├── image1.png
                ├── image2.jpg
                └── メモのタイトル.html  ← 自動保存される
```

### 利点

#### 1. **自動バックアップ**
- 保存するたびに最新のHTMLファイルが自動生成
- 削除やミスからの復旧が容易

#### 2. **簡単な共有**
- Boxフォルダを開くだけでHTMLファイルにアクセス可能
- エクスポート操作不要

#### 3. **外部アクセス**
- Boxの同期により、他のデバイスからも閲覧可能
- ブラウザでHTMLファイルを開くだけ

#### 4. **検索性**
- Finderやエクスプローラーでファイル検索可能
- Boxのウェブ版でも検索・プレビュー可能

#### 5. **バージョン履歴**
- Boxのバージョン履歴機能により、過去の状態を確認可能

## 動作フロー

```
ユーザーが保存ボタンをクリック
    ↓
update_page() が呼ばれる
    ↓
画像の移動・削除処理
    ↓
データベースに保存
    ↓
_save_html_to_folder() が呼ばれる
    ↓
HTMLファイルを生成
    ↓
page_X フォルダに保存
```

## HTMLファイルの内容

### 特徴

- **完全スタンドアロン**: 画像がBase64形式で埋め込まれている
- **レスポンシブデザイン**: モバイルでも見やすい
- **メタ情報**: 作成日時・更新日時が含まれる
- **美しいスタイル**: 読みやすいタイポグラフィー

### サンプル

```html
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>議事録 2025年10月</title>
    <style>
        /* レスポンシブCSSスタイル */
    </style>
</head>
<body>
    <h1>議事録 2025年10月</h1>
    <div class="meta">
        <p>作成日時: 2025年10月26日 23:00</p>
        <p>更新日時: 2025年10月26日 23:30</p>
    </div>
    <div class="content">
        <!-- メモの内容（画像はBase64埋め込み） -->
    </div>
</body>
</html>
```

## ファイル名のルール

### サニタイズ

以下の文字は自動的にアンダースコア（`_`）に置き換えられます：
- `< > : " / \ | ? *`

### 例

| ページタイトル | ファイル名 |
|---|---|
| 議事録 2025/10/26 | 議事録_2025_10_26.html |
| プロジェクト: Alpha | プロジェクト__Alpha.html |
| 設計書<重要> | 設計書_重要_.html |

## 更新時の動作

### タイトル変更時

タイトルを変更すると、新しいファイル名でHTMLファイルが保存されます。古いファイルは残ります。

**例：**
1. 最初: `メモ.html`
2. タイトル変更: 「メモ」→「重要メモ」
3. 保存後: `メモ.html` と `重要メモ.html` の両方が存在

### 古いファイルの削除

古いHTMLファイルは自動削除されません。必要に応じて手動で削除してください。

## トラブルシューティング

### HTMLファイルが生成されない

**原因:**
- フォルダの書き込み権限がない
- Boxの同期エラー

**確認方法:**
1. サーバーコンソールを確認
2. エラーメッセージを探す

**解決方法:**
```bash
# 権限を確認
ls -la ~/Library/CloudStorage/Box-Box/.../media/uploads/

# 権限を修正
chmod 755 ~/Library/CloudStorage/Box-Box/.../media/uploads/page_X/
```

### HTMLファイルが古い内容

**原因:**
- Boxの同期が遅い
- キャッシュの問題

**解決方法:**
1. Boxの同期状態を確認
2. ブラウザのキャッシュをクリア
3. ファイルの更新日時を確認

## サーバーログ

保存成功時の出力：

```
✓ Saved HTML to: /path/to/media/uploads/page_1/メモのタイトル.html
```

保存失敗時の出力：

```
✗ Warning: Failed to save HTML to /path/to/file: [エラー詳細]
```

## 実装詳細

### 関数

- `_save_html_to_folder(entity)`: HTMLファイルをフォルダに保存
- `_generate_html_content(entity)`: HTML内容を生成
- 両方とも `update_page()` から自動的に呼ばれる

### ファイルサイズ

- 画像をBase64で埋め込むため、元の画像より約33%大きくなります
- 例: 1MBの画像 → 約1.33MBのBase64データ

## 今後の改善案

- [ ] タイトル変更時に古いHTMLファイルを自動削除
- [ ] HTMLファイルのバージョン管理
- [ ] 複数フォーマットのエクスポート（Markdown、PDF）
- [ ] HTMLファイルの圧縮オプション
- [ ] カスタムCSSテンプレート


